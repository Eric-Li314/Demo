<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>止损(止盈)预挂单</title>
    <style>
        table th{
            //width:180px;
        }
    </style>
    <script src="jquery-1.8.3.min.js"></script>
    <script src="common.js"></script>
    <script>
        window.mycoin = {};
        window.interval_less = {}; //各个货币的定时编号，用于取消
        window.interval_more = {};
        window.order_price_less = {}; //各个货币的止损价格
        window.order_price_more = {};
        window.amount = {};
        window.ep_more = {};//各个货币涨时的邮箱通知标识
        window.ep_less = {};

        $(function(){
            //提交
            $('#start').click(function(){
                var coinname = $('input[name=coinname]').val();
                var price = $('input[name=price]').val();
                var amount = $('input[name=amount]').val();
                var range = $('input[name=range]').val();
                var type = $('select option:selected') .val();//选中的值
                var cprice = $('#cprice').html();
                var ep = $('input[name=email_push]:checked').val();//邮箱通知标志
                if(!price) {alert('买入价格不能为空');return false;}
                if(amount*1 == 0) {alert('数量为0'); return false;}
                alert("请务必确保买入价格是否正确！！！");
                //价格计算
                if(type == 'more'){
                    var order_price = price*1*(1+range*1);
                    window.order_price_more[coinname] = order_price;
                    window.ep_more[coinname] = ep;
                    var msg = '<b style="color:green">止盈('+Math.round(range*100)+'%)</b>';
                    var money = '<b style="color:green">+'+Math.round(amount*1*(order_price - price))+'</b>';
                }else if(type == 'less'){
                    var order_price = price*1*(1-range*1); //跌到这个价格就挂单卖出止损
                    window.order_price_less[coinname] = order_price;
                    window.ep_less[coinname] = ep;
                    var msg = '<b style="color:red">止损('+Math.round(range*100)+'%)</b>';
                    var money = '<b style="color:red">-'+Math.round(amount*1*(price - order_price))+'</b>';
                }

                order_price = Math.round(order_price*100000)/100000;
                var f = window.confirm('请确认以下数据!!!\n名称：'+coinname+'\n数量：'+amount+'\n卖价：'+order_price);
                if(!f) return false;
                //追加tr
                $('#tb').append(
                        '<tr class="'+coinname+type+'">' +
                        '<td>'+coins_arr[coinname]+'('+coinname+')</td>' +
                        '<td>'+price+'</td>' +
                        '<td>'+order_price+'</td>' +
                        '<td>'+amount+'</td>' +
                        '<td>'+money+'</td>' +
                        '<td>'+msg+'</td>' +
                        '<td class="order">挂单中...</td>' +
                        '<td>'+ep+'</td>' +
                        '<td><button class="cancel" param="'+type+'" coinname="'+coinname+'">取消</button></td>' +
                        '</tr>'
                );
                if(type == "less"){ //止损
                    window.interval_less[coinname] = setInterval(function(){ //保存相应货币的止损轮询值
                        //定时获取交易价格行情
                        $.post('api.php',{type:'get_ticker',coinname:coinname},function(ret){
                            var last = ret.ticker.last; //最新成家价格
                            console.log(coinname+':'+last);
                            if(last <= order_price){ //低于止损价位，挂单卖出
                                //设置止损挂单
                                $.post(
                                        'api.php',
                                        {type:'make_order',coinname:coinname,price:order_price,amount:amount},
                                        function(ret){
                                            console.log(ret);
                                            if(ret.indexOf('succ') != -1){ //挂单成功
                                                $("tr."+coinname+'less'+" td.order").html('<b style="color:blue">已挂单</b>');
                                                if(!window.ep_less[coinname]){//无邮箱通知
                                                    window.clearInterval(window.interval_less[coinname]);
                                                }
                                                $('button[coinname='+coinname+'][param=less]').remove();
                                            }else{
                                                alert('挂单失败：'+ret);
                                            }
                                        }
                                );
                                //邮箱通知
                                if(window.ep_less[coinname]){
                                    var content = coins_arr[coinname]+'：'+last +',跌幅超过预警';
                                    $.post(
                                            'api_email.php',
                                            {to_content:content,n:Math.random(),flag:'↓'},
                                            function(ret){
                                                console.log("email return："+ret);
                                                window.clearInterval(window.interval_less[coinname]);
                                            }
                                    );

                                }
                            }
                        },'json');
                    },5000);//5秒轮询一次
                }
                if(type == "more"){ //止盈
                    window.interval_more[coinname] = setInterval(function(){
                        //定时获取交易价格行情
                        $.post('api.php',{type:'get_ticker',coinname:coinname},function(ret){
                            var last = ret.ticker.last;
                            console.log(coinname+':'+last);
                            if(last >= order_price){ //大于止盈价位
                                //设置止盈挂单
                                $.post(
                                        'api.php',
                                        {type:'make_order',coinname:coinname,price:order_price,amount:amount},
                                        function(ret){
                                            console.log(ret);
                                            if(ret.indexOf('succ') != -1){ //挂单成功
                                                $("tr."+coinname+'more'+" td.order").html('<b style="color:blue">已挂单</b>');
                                                if(!window.ep_more[coinname])
                                                    window.clearInterval(window.interval_more[coinname]);
                                                $('button[coinname='+coinname+'][param=more]').remove();
                                            }else{
                                                window.clearInterval(window.interval_more[coinname]);//结束轮询
                                                alert('挂单失败：'+ret);
                                            }
                                        }
                                );
                                //邮箱通知
                                if(window.ep_more[coinname]){
                                    var content = coins_arr[coinname]+'：'+last+',涨幅超过预警';
                                    $.post(
                                            'api_email.php',
                                            {to_content:content,n:Math.random(),flag:'↑'},
                                            function(ret){
                                                console.log("email return："+ret);
                                                window.clearInterval(window.interval_more[coinname]);
                                            }
                                    );
                                }
                            }
                        },'json');
                    },5000);//5s轮询一次价格
                }

            });

            $('input[name=coinname]').blur(function(){
                var name = $(this).val();
                var coinname = $(this).val()+'_balance';
                $.post('api.php',{type:'get_my_balance'},function(ret){
                    window.mycoin = ret;console.log(ret);
                    var amount = ret[coinname];
                    window.amount[name] = amount;
                    $('input[name=amount]').val(amount);
                },'json');
                $.post('api.php',{type:'get_ticker',coinname:name},function(ret){
                    var last = ret.ticker.last;
                    $('#cprice').html(last);
                },'json');

            });

            //取消挂单
            $(document).on('click',' .cancel',function(){ //dom操作后的元素用此方式触发
                var name = $(this).attr('coinname');
                var param = $(this).attr('param');
                $(this).parent().parent('tr').remove();
                if(param == 'less')  var t = window.interval_less[name];
                if(param == 'more') var t = window.interval_more[name];

                window.clearInterval(t);
            });

            $('#change').change(function(){
                var a = $(this).val();
                if(a == 'more'){
                    $('input[name=range]').css('color','green');
                }else{
                    $('input[name=range]').css('color','red');
                }
            });
            var a = $('#change').val();
            if(a == 'more'){
                $('input[name=range]').css('color','green');
            }else{
                $('input[name=range]').css('color','red');
            }
        });
    </script>
</head>
<body>

<div style="text-align: center;">

   <table id="tb" align="center" border="1" style="border-collapse: collapse;margin-top:50px;width:98%">
       <tr style="background: darkred;color:white">
           <th colspan="15" align="center">
                止损/止盈预设挂单(比特时代)
           </th>
       </tr>
       <tr style="background: lightblue">
           <th colspan="15" align="left">
               货币名称：<input name="coinname" style="width:100px;"/>(货币英文代码，如btc/bts/ltc)<br/>
               买入价格：<input name="price" style="width:100px;"/>元 (当前价格：<b id="cprice" style="color:red"></b>)<br/>
               可用数量：<input name="amount" style="width:100px">(自动获取)<br/>
               变化幅度：<select name="change" id="change" style="width:80px;">
               <option value="more" selected="selected">涨幅</option>>
               <option value="less">跌幅</option>
                </select>
               <input name="range" value="0.1" style="width:100px;color:green">(0.1表示10%)<br/>
               邮箱通知：<input type="radio" name="email_push" value="1">是 &nbsp;
               <input type="radio" name="email_push" value="0" checked="checked">否<br/>
               <button id="start" style="width:80px;height:30px;cursor:pointer;background: green;color:yellow">启用</button>
           </th>
       </tr>
       <tr>
           <th nowrap="">币名</th>
           <th nowrap>买价</th>
           <th nowrap>卖价</th>
           <th nowrap>挂单数量</th>
           <th nowrap>资金变化</th>
           <th nowrap>止损(止盈)状态</th>
           <th nowrap>挂单状态</th>
           <th nowrap>邮箱通知</th>
           <th nowrap>操作</th>
       </tr>
   </table>

</div>
</body>
</html>