<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>预设买单</title>
    <style>
        input{
            margin-bottom:3px;
        }
    </style>
    <script src="jquery-1.8.3.min.js"></script>
    <script src="common.js"></script>
    <script>
        window.param = {};
        window.param.mycoin = {};//拥有币对应的价格 {btc:2,bts:1000}
        window.param.amount = {};//币=》数量
        window.param.interval = null; //轮询时间编号 默认设置为10秒一次
        window.param.email_push = {};//各个货币涨时的邮箱通知标识 {bts:1,xem:0} 1已发 0未发 一个货币只发一次

        //获取所有币的交易价格
        function get_all_trade(){
            console.log('get_all_rade is running now');
            console.log(window.param);

            $.ajax({
                type:'post',
                url:'api.php',
                data:{type:'get_ticker_all',n:Math.random()},
                dataType:'json', //返回类型
                success:function(ret){
                    //console.log(ret);
                    $.each(window.param.mycoin,function(i,e){ //i是币名 e是抄底买价
                        var last = ret[i].ticker.last; //最新成交价
                        console.log(coins_arr[i]+'最新成交价格：'+last);
                        if(last <= e){ //下跌到理想价位
                            $.post(
                                    'api.php',
                                    {trade_type:1,type:'make_order',coinname:i,price:last,amount:window.param.amount[i]},
                                    function(ret2){
                                        console.log(ret2);
                                        if(ret2.indexOf('succ') != -1){ //挂单成功
                                            $("tr."+i+" td.order_status").html('<b style="color:blue">已挂单</b>');
                                            if(window.param.email_push[i]){//邮箱通知
                                                $.post(
                                                        'api_email.php',
                                                        {to_content:coins_arr[i]+'：抄底挂单(买)',title:'挂单成功提醒'},
                                                        function(ret3){
                                                            console.log(ret3);
                                                        }
                                                );
                                            }
                                            $('tr.'+i+' .cancel').remove();
                                            clearInterval(window.param.interval);//结束轮询

                                        }else{
                                            console.log('挂单失败：'+ret2);
                                            delete window.param.mycoin[i];
                                        }
                                    }
                            );
                        }
                    });
                }
            });
        }

        $(function(){
            //获取账户余额-cny
            $.post('api.php',{type:'get_my_balance'},function(ret){
                console.log("获取账户cny余额");
                var money = ret.cny_balance;
                money = Math.floor(money);
                $('#mymoney').html(money);
            },'json');

            var task_start_flag = 1;//保证轮询任务只有一个

            //提交
            $('#start').click(function(){
                var coinname = $('input[name=coinname]').val();
                var price = $('input[name=price]').val();
                var amount = $('input[name=amount]').val();
                var ep = 1;//邮箱通知标志

                if(window.param.mycoin[coinname]){alert('该币已经预设过了');return false;};
                if(!price) {alert('买入价格不能为空');return false;}
                if(amount*1 == 0) {alert('数量为0'); return false;}

                var cprice = $('#cprice').html()*1;
                if(cprice <= price){
                    alert('警告！抄底价格大于当前价格！！！');
                    return false;
                }

                window.param.email_push[coinname] = ep;
                window.param.mycoin[coinname] = price;//保存币的价格
                window.param.amount[coinname] = amount;

                console.log(window.param);

                var total = Math.round(amount*1*price*1);
                //追加tr
                $('#tb').append(
                        '<tr class="'+coinname+'">' +
                        '<td>'+coins_arr[coinname]+'('+coinname+')</td>' +
                        '<td>'+price+'</td>' +
                        '<td>'+amount+'</td>' +
                        '<td>'+total+'</td>' +
                        '<td class="order_status">挂单中...</td>' +
                        '<td>'+ep+'</td>' +
                        '<td><button class="cancel">取消</button></td>' +
                        '</tr>'
                );

                //复位
                $('input[name]').val('');
                $('#coinname_chn,#cprice').html('');

                //开启轮询任务,保证只执行一次
                if(task_start_flag == 1){
                    window.param.interval = setInterval(get_all_trade,10*1000);//10s一次
                    task_start_flag = 0;
                }


            });

            $('input[name=coinname]').blur(function(){
                var name = $(this).val();
                if(coins_arr[name])
                    $('#coinname_chn').html(coins_arr[name]);
                else
                    $('#coinname_chn').html('未知');
                //获取最新价格
                $.post('api.php',{type:'get_ticker',coinname:name},function(ret){
                    var last = ret.ticker.last;
                    $('#cprice').html(last);
                },'json');
            });

            $('input[name=price]').blur(function(){
                var price = $(this).val()*1;
                var cprice = $('#cprice').html()*1;
                if(cprice <= price){
                    alert('警告！抄底价格大于当前价格！！！');
                    return false;
                }
                //获取账户余额-cny
                var money = $('#mymoney').html()*1;
                var amount = Math.floor(money/price*100)/100;
                $('input[name=amount]').val(amount);
            });

            //取消挂单
            $(document).on('click',' .cancel',function(){ //dom操作后的元素用此方式触发

                var coinname = $(this).parent().parent().attr('class');
                delete window.param.mycoin[coinname];
                if(isEmptyObject(window.param.mycoin)){ //没有需要执行轮询的币
                    clearInterval(window.param.interval);//结束轮询
                    task_start_flag = 1;//重新开启轮询标识
                }
                $(this).parent().parent().remove();
                console.log(window.param);
            });
        });

        function isEmptyObject(e) {
            var t;
            for (t in e)
                return !1;
            return !0
        }
    </script>
</head>
<body>

<div style="text-align: center;">

   <table id="tb" align="center" border="1" style="border-collapse: collapse;margin-top:50px;width:98%">
       <tr style="background: darkred;color:white">
           <th colspan="15" align="center">
                预设买单(比特时代)
           </th>
       </tr>
       <tr style="background: lightblue">
           <th colspan="15" align="left">
               货币英文：<input name="coinname" style="width:100px;"/>(货币名称：<b id="coinname_chn" style="color:red"></b>)<br/>
               挂单价格：<input name="price" style="width:100px;"/>(当前价格：<b id="cprice" style="color:red"></b>)<br/>
               可挂数量：<input name="amount" style="width:100px" placeholder="自动计算">(我的cny余额：<b id="mymoney" style="color:red"></b>)<br/>
               邮箱通知：已开启<br/>
               <button id="start" style="width:80px;height:30px;cursor:pointer;background: green;color:yellow">启用</button>
           </th>
       </tr>
       <tr>
           <th nowrap>币名</th>
           <th nowrap>挂单价格</th>
           <th nowrap>挂单数量</th>
           <th nowrap>总价</th>
           <th nowrap>挂单状态</th>
           <th nowrap>邮箱通知</th>
           <th nowrap>操作</th>
       </tr>
   </table>

</div>
</body>
</html>