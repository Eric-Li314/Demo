<!--
用于电脑端的弹窗提示和语音提示
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>价格变化监控</title>
    <!--<link rel="icon" href="favicon.ico" mce_href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" mce_href="favicon.ico" type="image/x-icon">-->
    <style>
        .cc{
            width:140px;
            display: inline-block;
        }
        #emailpush p{
            margin:3px 0;
        }
    </style>
    <script src="jquery-1.8.3.min.js"></script>
    <script src="common.js"></script>
    <script>
        function showNotice(title,msg){
            var Notification = window.Notification || window.mozNotification || window.webkitNotification;
            if(Notification){
                Notification.requestPermission(function(status){
                    //status默认值'default'等同于拒绝 'denied' 意味着用户不想要通知 'granted' 意味着用户同意启用通知
                    if("granted" != status){
                        return;
                    }else{
                        var tag = "sds"+Math.random();
                        var notify = new Notification(
                                title,
                                {
                                    dir: "auto",
                                    tag: "testTag",
                                    //icon: URL + 'static/js/webim/images/text-message.png',
                                    body: msg,
                                    silent: true,
                                    sticky: true,
                                    renotify:true
                                }
                        );
                        notify.onclick=function(){
                            //如果通知消息被点击,通知窗口将被激活
                            window.focus();
                            //window.open('http://www.btc38.com/','_blank')

                        };
                        notify.onerror = function () {
                            console.log("HTML5桌面消息出错！！！");
                        };
                        notify.onshow = function () { //设置延时关闭弹窗
                            /*setTimeout(function(){
                                notify.close();
                            },15000)*/
                        };
                        notify.onclose = function () {
                            //notify.onshow();//弹窗不消失
                            //console.log("HTML5桌面消息关闭！！！");
                        };
                    }
                });
            }else{
                console.log("您的浏览器不支持桌面消息");
            }
        };
        //获取最近交易价格，生成语音报告文件
        function get_trade(){
            console.log('get_trade run,'+'间隔运行：'+window.pop_interval+"s");
            $.ajax({
                type:'post',
                url:'api.php',
                data:{type:'get_ticker_all',n:Math.random()},
                dataType:'json', //返回类型
                success:function(ret){
                    if(!ret){
                        console.log('没有获取到结果');
                        return false;
                    }
                    var data = ''; //右下角弹出内容
                    var text = ''; //语音合成内容
		            var num = 1;
                    $.each(window.coin,function(i,e){
		                if(num%3 == 0) //每行显示3个
                            data += e+"("+ret[e].ticker.last+')  \r\n';
		                else
		                    data += e+"("+ret[e].ticker.last+')   ';
		                num++;
                        //语音提示文本
                        text += coins_arr[e]+ret[e].ticker.last+',';
                    });
                    if(window.pop == 1){
                        showNotice('',data);
                    }

                    //调用语音合成接口，生成最新的价格语音文件 coins_price.mp3
                    $.post('api_voice.php', {text:text,n:Math.random()}, function(ret){});
                }
            });
        }
        //获取语音价格播放
        function get_voice(){
            console.log('get_voice run,'+'间隔运行：'+window.voice_interval+'s');
            if($('#aaa').length = 0){
                $('body').append('<embed id="aaa" style="visibility: hidden" src="coins_price.mp3"></embed>');
            }else{
                $('#aaa').remove();
                $('body').append('<embed id="aaa" style="visibility: hidden" src="coins_price.mp3"></embed>');
            }
        }
        window.coin = {}; //已选择需要监视的币
        window.pop = 0; //右下角弹窗控制标识 1开启 0关闭
        window.pop_interval = 0;//弹窗时间间隔
        window.voice_interval = 0;//语音播报时间间隔
        $(function(){
            //动态生成所有币的复选框，供选择性监视
            $.post(
                    'api.php',
                    {type:'get_ticker_all'},
                    function(data){
                        console.log(data);
                        $('#coins').html('');
                        var num = 1;
                        $.each(data,function(i,e){
                            if(coins_arr[i] == undefined){return true;}
                            //每行8个
                            if(num%5 == 0)
                                var htmlstr = "<div class='cc'><input type='checkbox' id='"+i+"' name='coin' value='"+i+"'>" +
                                        "<label for='"+i+"'>"+coins_arr[i]+'('+i+')</label></div><br/>';
                            else
                                var htmlstr = "<div class='cc'><input type='checkbox' id='"+i+"' name='coin' value='"+i+"'>" +
                                        "<label for='"+i+"'>"+coins_arr[i]+'('+i+')</label></div>';

                            $('#coins').append(htmlstr);
                            num++;
                        });
                    },'json'
            );
            var flag = 1;//监视启用、停用标志
            var flag2 = 1;//语音
            var t = null;//轮询交易计时器
            var tv = null;//轮询语音报告计时器
            $('#btn').click(function(){ //启用价格监视
                var ch = $('input[type=checkbox]:checked');
                if(ch.length == 0) {
                    alert('请选择至少一个');
                    return false;
                }
                //获取时间间隔
                window.pop_interval = parseInt($('input[name=poptime]').val());
                window.voice_interval = parseInt($('input[name=voicetime]').val());
                if(isNaN(window.pop_interval) || isNaN(window.voice_interval)){
                    alert('时间间隔请填写数字');
                    return false;
                }
                var tt = window.pop_interval;
                if(!tt || tt < 5){
                    alert('监视时间间隔至少5秒');
                    return false;
                }
                ch.each(function(i,e){
                    console.log($(this).val());
                    window.coin[i] = e.value;
                });

                $('input[name]').attr('disabled',true);

                if(flag == 1){
                    t = setInterval(get_trade,tt*1000);//定时查询交易数据
                    $('#btn').html('停用监视');
                    flag = 0;
                } else if(flag == 0){
                    window.clearInterval(t);
                    $('#btn').html('启用监视');
                    $('input[type=checkbox]').attr('disabled',false);
                    $('input[name=poptime],input[name=voicetime]').attr('disabled',false);
                    flag = 1;
                    //关闭语音
                    window.clearInterval(tv);
                    $('#btn2').html('启用语音');
                    $('#info2').css('color','darkred').html('未启用');
                    flag2 = 1;
                    //关闭弹窗
                    window.pop = 0;
                    $('#btn3').html('启用弹窗');
                    $('#info').css('color','darkred').html('未启用');

                }
            });
            $('#btn2').click(function(){
                if(flag == 1){
                    alert('请先启用监视');
                    return false;
                }
                if(flag2 == 1){
                    tv = setInterval(get_voice,window.voice_interval*1000);//定时播放价格语音提示
                    $('#btn2').html('停用语音');
                    $('#info2').css('color','green').html('已启用');
                    flag2 = 0;
                } else if(flag2 == 0){
                    window.clearInterval(tv);
                    $('#btn2').html('启用语音');
                    $('#info2').css('color','darkred').html('未启用');
                    flag2 = 1;
                }
            });
            $('#btn3').click(function(){
                if(flag == 1){
                    alert('请先启用监视');
                    return false;
                }
                if(window.pop == 1){
                    $(this).html('启用弹窗');
                    $('#info').css('color','darkred').html('未启用');
                    window.pop = 0;
                }else{
                    $(this).html('停用弹窗');
                    $('#info').css('color','green').html('已启用');
                    window.pop = 1;
                }
            });
            //设置默认时间间隔
            $('input[name=poptime]').val(10);
            $('input[name=voicetime]').val(60);
        });
    </script>
</head>
<body>
<div style="width:90%;text-align: left;">
    <p>请选择对应币种进行监视</p>
    <div id="coins" style="width:99%;margin-bottom:5px;"><p style="color:red">正在加载数字货币...</p></div>
    <div id="interval" style="margin:15px 0;">
        价格监视间隔(秒)：<input type="text" name="poptime" style="width:50px;">(与弹窗间隔一致)<br/>
        语音播报间隔(秒)：<input type="text" name="voicetime" style="width:50px;"><br/>
    </div>
    <button id="btn"
            style="width:80px;height:30px;background: green;color:white;border:1px solid green;font-size:14px;cursor:pointer">
        启用监视
    </button>
    <button id="btn2"
            style="width:80px;height:30px;background: green;color:white;border:1px solid green;font-size:14px;cursor:pointer">
        启用语音
    </button>
    <button id="btn3" state=0
            style="width:80px;height:30px;background: green;color:white;border:1px solid green;font-size:14px;cursor:pointer">
        启用弹窗
    </button>
    <p>弹窗状态：<span id="info" style="color:darkred">未启用</span></p>
    <p>播报状态：<span id="info2" style="color:darkred">未启用</span></p>
</div>
</body>
</html>