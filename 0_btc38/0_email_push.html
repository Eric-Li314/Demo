<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>邮件推送</title>
    <!--<link rel="icon" href="favicon.ico" mce_href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" mce_href="favicon.ico" type="image/x-icon">-->
    <style>
        .cc{
            width:140px;
            display: inline-block;
        }
        input[name=more] {
            margin:3px 0;
        }
    </style>
    <script src="jquery-1.8.3.min.js"></script>
    <script src="common.js"></script>
    <script>

        //获取最近交易价格,触发邮箱推送
        function get_trade(){
            console.log('get_trade run');
            console.log(window.param);
            $.ajax({
                type:'post',
                url:'api.php',
                data:{type:'get_ticker_all',n:Math.random()},
                dataType:'json', //返回类型
                success:function(ret){
                    if(!ret){
                        console.log('没有获取到结果');
                        return false;
                    }
                    $.each(window.param.coins,function(i,e){
                        if(!window.param.coins[i]){
                            //初次运行设置基准价格
                            console.log('设置'+coins_arr[i]+'基准价格');
                            window.param.coins[i] = 1*ret[i].ticker.last
                        }else{ //涨跌幅度判断
                            var current_price = 1*ret[i].ticker.last;//当前最新价格
                            var diff_price = Math.round((current_price - window.param.coins[i])*10000)/10000;//价格差，保留小数点后5位
                            var price_change = diff_price/window.param.coins[i];//价格变化百分比
                            price_change = Math.floor(price_change*1000)/1000;//保留小数点后3位
                            //变化倍数为预设的整数倍且在该梯度没有被通知过时则发邮件通知
                            var change = 0;//变化跌幅（为预设梯度的整数倍）
                            if(price_change > 0){
                               var change_times = parseInt(price_change/window.param.more);//变化倍数，取整
                                change = change_times*1*window.param.more;
                            }else if(price_change < 0){
                               var change_times = parseInt(price_change/window.param.less);
                                change = change_times*1*window.param.less;
                            }
                            change = Math.floor(change*1000)/1000;
                            //执行通知  排除变化为0或者变化幅度达不到预设梯度的最低值（如0.01/0.1取整后为0）
                            if(change){
                                if(window.param.range_list[i].indexOf(change) == -1){//不存在，则进行邮件通知
                                    var text = coins_arr[i]+'：'+current_price+'，'+Math.round(change*100)+'%';
                                    $.post(
                                            'api_email.php',
                                            {to_content:text,n:Math.random(),flag:''},
                                            function(ret){
                                                console.log(ret);
                                                window.param.range_list[i].push(change);//通知过的价格写入数组中
                                                console.log(window.param);
                                            }
                                    );
                                    /*if(change == 0.1 || change == -0.1){
                                        //直接发短信
                                        $.post(
                                                'api_sms.php',
                                                {msg:text,n:Math.random(),phone:13629795255},
                                                function(ret){}
                                        );
                                    }*/
                                }

                            }
                        }
                    });
                }
            });
        }
        window.param = {};
        window.param.coins = {}; //已选择需要监视的币和对应的基准价格，{'coinname':'price'}
        window.param.range_list = {};//具体的变化幅度 {btc:[0.1,0.2,-0.1]}
        $(function(){
            //动态生成所有币的复选框，供选择性监视
            $.post(
                    'api.php',
                    {type:'get_ticker_all'},
                    function(data){
                        console.log(data);
                        $('#coins').html('');
                        var num = 1;
                        $.each(data,function(i,e){
                            if(coins_arr[i] == undefined){return true;}
                            //每行8个
                            if(num%5 == 0)
                                var htmlstr = "<div class='cc'><input type='checkbox' id='"+i+"' name='coin' value='"+i+"'>" +
                                        "<label for='"+i+"'>"+coins_arr[i]+'('+i+')</label></div><br/>';
                            else
                                var htmlstr = "<div class='cc'><input type='checkbox' id='"+i+"' name='coin' value='"+i+"'>" +
                                        "<label for='"+i+"'>"+coins_arr[i]+'('+i+')</label></div>';

                            $('#coins').append(htmlstr);
                            num++;
                        });
                    },'json'
            );
            var flag = 1;//监视启用、停用标志
            $('#btn').click(function(){ //启用邮件价格通知
                var ch = $('input[type=checkbox]:checked');
                if(ch.length == 0) {
                    alert('请选择至少一个虚拟货币！');
                    return false;
                }
                window.param.coins = {};//复位
                ch.each(function(i,e){
                    window.param.coins[$(this).val()] = 0;//初始化价格为0
                    window.param.range_list[$(this).val()] = [];//初始化梯度数组[0.1,0.2,-0.1]
                    $(this).parent().css('color','red');
                });

                //获取时间间隔
                var interval = parseInt($('input[name=pollingtime]').val());
                if(isNaN(interval) || interval < 5){
                    alert('轮询间隔请设置至少5秒');
                    return false;
                }
                //设置涨幅/跌幅 梯度值
                window.param.more = parseFloat($('input[name=more]').val());
                window.param.less = parseFloat($('input[name=less]').val());
                if(window.param.more/0.01 <1 || window.param.less/0.01 <1){
                    alert('梯度的最小粒度为0.01');
                    return false;
                }

                $('input[name]').attr('disabled',true);//开启后所有input框禁用

                if(flag == 1){
                    window.polling_time_number = setInterval(get_trade,interval*1000);//定时查询交易数据
                    $('#btn').html('停用推送');
                    $('#info').html('已启用').css('color','green');
                    flag = 0;
                } else if(flag == 0){
                    window.clearInterval(window.polling_time_number);//关闭轮询
                    $('#btn').html('启用推送');
                    $('#info').html('未启用').css('color','darkred');
                    $('input[name]').attr('disabled',false).parent().css('color','black');
                    flag = 1;
                }
                console.log(window.param);
            });

            //设置初始值
            $('input[name=pollingtime]').val(30);
            $('input[name=more]').val(0.1);
            $('input[name=less]').val(0.1);

        });
    </script>
</head>
<body>
<div style="width:90%;text-align: left;">
    <p>请选择对应币种进行价格变动的邮件推送</p>
    <div id="coins" style="width:99%;margin-bottom:5px;"><p style="color:red">正在加载数字货币...</p></div>
    <div id="interval">
        轮询间隔设置：<input type="text" name="pollingtime" style="width:50px;">(秒)<br/>
        涨幅通知梯度：<input type="text" name="more" style="width:40px;">(小数 0.1表示10%)<br/>
        跌幅通知梯度：<input type="text" name="less" style="width:40px;"><br/><br/>
    </div>
    <button id="btn"
            style="width:80px;height:30px;background: green;color:white;border:1px solid green;font-size:14px;cursor:pointer">
        启用推送
    </button>
    <p>邮件推送状态：<span id="info" style="color:darkred">未启用</span></p>
</div>
<p style="font-size: 12px">说明：价格涨幅或者跌幅的基准价格是启用推送任务后首次获得的货币价格</p>
</body>
</html>