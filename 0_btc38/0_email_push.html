<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>邮件推送</title>
    <!--<link rel="icon" href="favicon.ico" mce_href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" mce_href="favicon.ico" type="image/x-icon">-->
    <style>
        table th{
            width:180px;
        }
        input[type=checkbox]{

        }
        .cc{
            width:140px;
            display: inline-block;
        }
        input[name=more] {
            margin:3px 0;
        }
    </style>
    <script src="jquery-1.8.3.min.js"></script>
    <script src="common.js"></script>
    <script>

        //获取最近交易价格,触发邮箱推送
        function get_trade(){
            console.log('get_trade run');
            console.log(window.email_flag);
            //检测是否已发送所有邮件通知
            var send_all = 1;
            $.each(window.email_flag,function(i,e){
                if(e == 0){
                    send_all = 0;
                    return false;
                }
            });
            if(send_all == 1){ //全部发送完毕,复位初始状态
                window.clearInterval(window.polling_time_number);//关闭轮询
                $('#btn').html('启用推送');
                $('#info').html('未启用').css('color','darkred');
                $('input[name]').attr('disabled',false).parent().css('color','black');
                flag = 1;
            }
            $.ajax({
                type:'post',
                url:'api.php',
                data:{type:'get_ticker_all',n:Math.random()},
                dataType:'json', //返回类型
                success:function(ret){
                    var text = ''; //邮件通知内容
                    var flag = null;
                    $.each(window.coins,function(i,e){
                        if(!window.coins[i]){ //初次运行设置基准价格
                            console.log('设置'+coins_arr[i]+'基准价格');
                            window.coins[i] = 1*ret[i].ticker.last
                        }else{ //涨跌幅度判断
                            var current_price = 1*ret[i].ticker.last;//当前最新价格
                            var diff_price = Math.round((current_price - window.coins[i])*10000)/10000;//价格差，保留小数点后5位
                            var price_change = Math.abs(diff_price)/window.coins[i];//价格变化百分比
                            price_change = Math.round(price_change*100)/100;//保留小数点后5位
                            if(window.email_flag[i]){//已发送，涨或跌只发送一次
                                return true;//continue
                            }
                            console.log(coins_arr[i]+"当前价："+current_price+'，基准价：'+window.coins[i]+'，价格变化：'+diff_price+'，变化百分比：'+price_change*100+"%");
                            if(diff_price > 0 && price_change >= (window.more*1/100)){ //涨
                                text += "<p style='color:green'>"+coins_arr[i]+'：'+current_price+',涨幅超过'+window.more+'%</p>';
                                window.email_flag[i] = 1;
                            }else if(diff_price < 0 && price_change >= (window.more*1/100)){ //跌
                                text += '<p style="color:red">'+coins_arr[i]+'：'+current_price+',跌幅超过'+window.more+'%</p>';
                                window.email_flag[i] = 1;
                            }
                        }
                    });
                    if(text){
                        $.post(
                                'api_email.php',
                                {to_content:text,n:Math.random(),flag:''},
                                function(ret){
                                    console.log(ret);
                                }
                        );
                    }

                }
            });
        }

        window.coins = {}; //已选择需要监视的币，{'coinname':'price'}
        window.more = 0;//涨幅
        window.less = 0;//跌幅
        window.polling_time_number = null;//周期轮询任务的时间编号
        window.email_flag = {};
        $(function(){
            //动态生成所有币的复选框，供选择性监视
            $.post(
                    'api.php',
                    {type:'get_ticker_all'},
                    function(data){
                        console.log(data);
                        $('#coins').html('');
                        var num = 1;
                        $.each(data,function(i,e){
                            if(coins_arr[i] == undefined){return true;}
                            //每行8个
                            if(num%5 == 0)
                                var htmlstr = "<div class='cc'><input type='checkbox' id='"+i+"' name='coin' value='"+i+"'>" +
                                        "<label for='"+i+"'>"+coins_arr[i]+'('+i+')</label></div><br/>';
                            else
                                var htmlstr = "<div class='cc'><input type='checkbox' id='"+i+"' name='coin' value='"+i+"'>" +
                                        "<label for='"+i+"'>"+coins_arr[i]+'('+i+')</label></div>';

                            $('#coins').append(htmlstr);
                            num++;
                        });
                    },'json'
            );
            var flag = 1;//监视启用、停用标志
            $('#btn').click(function(){ //启用邮件价格通知
                var ch = $('input[type=checkbox]:checked');
                if(ch.length == 0) {
                    alert('请选择至少一个虚拟货币！');
                    return false;
                }
                window.coins = {};//复位
                window.email_flag = {};//复位
                ch.each(function(i,e){
                    window.coins[$(this).val()] = null;
                    window.email_flag[$(this).val()] = 0;//初始为 未发送
                    $(this).parent().css('color','red');
                });
                console.log(window.coins);
                console.log(window.email_flag);
                //获取时间间隔
                var interval = parseInt($('input[name=pollingtime]').val());
                if(isNaN(interval) || interval < 5){
                    alert('轮询间隔请设置至少5秒');
                    return false;
                }
                //获取涨幅间隔
                window.more = parseInt($('input[name=more]').val());
                //获取跌幅间隔
                window.less = parseInt($('input[name=less]').val());

                $('input[name]').attr('disabled',true);//开启后所有input框禁用

                if(flag == 1){
                    window.polling_time_number = setInterval(get_trade,interval*1000);//定时查询交易数据
                    $('#btn').html('停用推送');
                    $('#info').html('已启用').css('color','green');
                    flag = 0;
                } else if(flag == 0){
                    window.clearInterval(window.polling_time_number);//关闭轮询
                    $('#btn').html('启用推送');
                    $('#info').html('未启用').css('color','darkred');
                    $('input[name]').attr('disabled',false).parent().css('color','black');
                    flag = 1;
                }
            });

            $('input[name=pollingtime]').val(60);
            $('input[name=more]').val(10);
            $('input[name=less]').val(10);

        });
    </script>
</head>
<body>
<div style="width:90%;text-align: left;">
    <p>请选择对应币种进行价格变动的邮件推送</p>
    <div id="coins" style="width:99%;margin-bottom:5px;"><p style="color:red">正在加载数字货币...</p></div>
    <div id="interval">
        轮询间隔设置：<input type="text" name="pollingtime" style="width:50px;">(秒)<br/>
        涨幅通知设置：<input type="text" name="more" style="width:30px;">%(百分比)<br/>
        跌幅通知设置：<input type="text" name="less" style="width:30px;">%(百分比)<br/><br/>
    </div>
    <button id="btn"
            style="width:80px;height:30px;background: green;color:white;border:1px solid green;font-size:14px;cursor:pointer">
        启用推送
    </button>
    <p>邮件推送状态：<span id="info" style="color:darkred">未启用</span></p>
</div>
<p style="font-size: 12px">说明：价格涨幅或者跌幅的基准价格是启用推送任务后首次获得的货币价格</p>
</body>
</html>